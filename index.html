<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ACS Minimal Auth/Provision Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      max-width: 900px; 
      margin: 2rem auto; 
      padding: 0 1rem;
      line-height: 1.6;
    }
    input { 
      margin: 0.25rem; 
      padding: 0.6rem; 
      width: 320px; 
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button { 
      margin: 0.25rem; 
      padding: 0.6rem 1rem; 
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #6c757d; cursor: not-allowed; }
    pre { 
      background: #f8f9fa; 
      padding: 1rem; 
      white-space: pre-wrap; 
      border-radius: 4px;
      border: 1px solid #e9ecef;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .row { margin: 0.75rem 0; }
    .section { 
      margin: 2rem 0; 
      padding: 1.5rem; 
      border: 1px solid #e9ecef; 
      border-radius: 8px;
      background: #fdfdfd;
    }
    .status { 
      padding: 0.5rem 1rem; 
      border-radius: 4px; 
      margin: 0.5rem 0;
      font-weight: 500;
    }
    .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 0.5rem; }
    h2 { color: #495057; margin-top: 2rem; }
    h3 { color: #6c757d; }
    .button-group { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .input-group { display: flex; flex-direction: column; margin: 0.5rem 0; }
    .input-group label { font-weight: 500; margin-bottom: 0.25rem; color: #495057; }
    .repo-item { 
      display: flex; 
      align-items: center; 
      padding: 0.5rem; 
      margin: 0.25rem 0; 
      border: 1px solid #dee2e6; 
      border-radius: 4px; 
      background: white;
      cursor: pointer;
    }
    .repo-item:hover { background: #e9ecef; }
    .repo-item input[type="radio"] { margin-right: 0.75rem; }
    .repo-info { flex: 1; }
    .repo-name { font-weight: 500; color: #495057; }
    .repo-details { font-size: 12px; color: #6c757d; margin-top: 0.25rem; }
    .auto-poll-active { background: #28a745 !important; }
    .auto-poll-active:hover { background: #218838 !important; }
  </style>
</head>
<body>
  <h1>ğŸ­ ACS Minimal Auth/Provision Test</h1>
  <div id="status" class="status info">Ready to test Supabase â†’ ACS authentication flow</div>

  <div class="section">
    <h2>âš™ï¸ Configuration</h2>
    
    <div class="input-group">
      <label for="acsBaseUrl">ACS Server URL</label>
      <input id="acsBaseUrl" type="url" placeholder="https://orchestra-acs-web.fly.dev" value="https://orchestra-acs-web.fly.dev" />
      <small style="color: #6c757d; font-size: 12px;">
        Local: https://orchestra-acs-web.fly.dev | Ngrok: https://your-ngrok-url.ngrok.io
      </small>
    </div>
    
    <div class="button-group">
      <button id="btnUpdateConfig">ğŸ”„ Update Configuration</button>
      <button id="btnResetConfig">ğŸ  Reset to Local</button>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ” Authentication</h2>
    
    <div class="input-group">
      <label for="email">Email</label>
      <input id="email" type="email" placeholder="your-email@example.com" value="test@example.com" />
    </div>
    
    <div class="input-group">
      <label for="password">Password</label>
      <input id="password" type="password" placeholder="password" value="testpassword123" />
    </div>

    <div class="button-group">
      <button id="btnRegister">ğŸ“ Supabase Register</button>
      <button id="btnLogin">ğŸ”‘ Supabase Login</button>
      <button id="btnLogout">ğŸšª Supabase Logout</button>
    </div>

    <div class="button-group">
      <button id="btnShowSession">ğŸ‘ï¸ Show Supabase Session</button>
      <button id="btnExchange">ğŸ”„ Exchange for ACS Cookies</button>
      <button id="btnWhoAmI">ğŸ‘¤ ACS: Who Am I (/auth/me)</button>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ™ GitHub Integration</h2>
    
    <div class="button-group">
      <button id="btnGithubInstall">ğŸ”— Connect GitHub (Install App)</button>
      <button id="btnListInstalls">ğŸ“¦ My Installations</button>
      <button id="btnListRepos">ğŸ“š My Repos</button>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ—ï¸ Infrastructure Provisioning</h2>
    
    <h3>ğŸ¯ Repo Selection & Provisioning (New UI)</h3>
    <div class="button-group">
      <button id="btnLoadRepos">ğŸ“š Load My Repos</button>
      <button id="btnProvisionSelected">ğŸš€ Provision Selected Repo</button>
      <button id="btnCheckRepoStatusSelected">ğŸ“Š Check Selected Repo Status</button>
      <button id="btnToggleAutoPoll">ğŸ”„ Toggle Auto Poll (5s)</button>
    </div>
    
    <div class="input-group">
      <label for="pollBranch">Branch for Status Polling</label>
      <input id="pollBranch" type="text" placeholder="main" value="main" />
      <small style="color: #6c757d; font-size: 12px;">
        Branch to use for status polling and provisioning selected repo
      </small>
    </div>
    
    <div id="repoListContainer" style="margin-top: 1rem;">
      <h4>ğŸ“‹ Available Repositories</h4>
      <div id="repoList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 4px; padding: 1rem; background: #f8f9fa;">
        <p style="color: #6c757d; font-style: italic;">Click "Load My Repos" to see your accessible repositories</p>
      </div>
    </div>

    <h3>ğŸ“š Manual Provision with Repository (Legacy)</h3>
    <div class="input-group">
      <label for="repoId">Repository ID (number)</label>
      <input id="repoId" type="number" placeholder="123456789" value="123456789" />
    </div>
    
    <div class="input-group">
      <label for="repoName">Repository Full Name</label>
      <input id="repoName" type="text" placeholder="owner/repository-name" value="octocat/Hello-World" />
    </div>
    
    <div class="input-group">
      <label for="branch">Branch</label>
      <input id="branch" type="text" placeholder="main" value="main" />
    </div>
    
    <div class="button-group">
      <button id="btnProvisionRepo">ğŸš€ Provision With Repo (legacy)</button>
      <button id="btnCheckRepoStatus">ğŸ“Š Check Repo Status (legacy)</button>
    </div>

    <h3>ğŸ”’ Legacy App-Per-User Provisioning</h3>
    <div class="button-group">
      <button id="btnProvisionTest">ğŸ§ª Provision (no auth) /infrastructure/provision-test</button>
      <button id="btnProvision" title="Legacy app-per-user path">ğŸ”’ Provision (legacy)</button>
      <button id="btnInfraStatus">ğŸ“Š Infrastructure Status</button>
    </div>
  </div>

  <div class="section">
    <h2>ğŸ“‹ Output</h2>
    <pre id="out">Click any button above to see the API response...</pre>
  </div>

<script>
  // Your Supabase project configuration
  const SUPABASE_URL = "https://wurmfjxtyntxnstqbyms.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1cm1manh0eW50eG5zdHFieW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3Nzg2NTgsImV4cCI6MjA2MzM1NDY1OH0.jVjPr-AesbxARpPC0YLtHYQy9OGqdEA5FowJPYKwBcc";

  // ACS base URL (configurable)
  let ACS_BASE = "https://orchestra-acs-web.fly.dev/api/v1";

  const out = document.getElementById('out');
  const status = document.getElementById('status');
  
  function updateStatus(message, type = 'info') {
    status.className = `status ${type}`;
    status.textContent = message;
  }
  
  function log(obj, title = "") {
    const timestamp = new Date().toLocaleTimeString();
    const output = (title ? `[${timestamp}] ${title}\n` : `[${timestamp}] `) + JSON.stringify(obj, null, 2);
    out.textContent = output;
    console.log(title || 'API Response:', obj);
  }

  // Configuration functions
  function updateConfiguration() {
    const newBaseUrl = document.getElementById('acsBaseUrl').value.trim();
    if (!newBaseUrl) {
      updateStatus('Please enter a valid ACS server URL', 'error');
      return;
    }
    
    // Remove trailing slash and add /api/v1
    const cleanUrl = newBaseUrl.replace(/\/$/, '');
    ACS_BASE = `${cleanUrl}/api/v1`;
    
    updateStatus(`Configuration updated! ACS Base: ${ACS_BASE}`, 'success');
    log({ 
      action: 'config_updated', 
      old_base: 'previous_value',
      new_base: ACS_BASE,
      timestamp: new Date().toISOString()
    }, "Configuration Update");
  }
  
  function resetConfiguration() {
    const defaultUrl = "https://orchestra-acs-web.fly.dev";
    document.getElementById('acsBaseUrl').value = defaultUrl;
    ACS_BASE = `${defaultUrl}/api/v1`;
    
    updateStatus('Configuration reset to local development', 'info');
    log({ 
      action: 'config_reset', 
      base_url: ACS_BASE,
      timestamp: new Date().toISOString()
    }, "Configuration Reset");
  }

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function register() {
    updateStatus('Registering with Supabase...', 'info');
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
      updateStatus('Please enter both email and password', 'error');
      return;
    }
    
    try {
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) {
        updateStatus(`Registration failed: ${error.message}`, 'error');
      } else {
        updateStatus('Registration successful! Check your email for confirmation.', 'success');
      }
      log({data, error}, "Register");
    } catch (err) {
      updateStatus(`Registration error: ${err.message}`, 'error');
      log({error: err.message}, "Register Error");
    }
  }

  async function login() {
    updateStatus('Logging in with Supabase...', 'info');
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
      updateStatus('Please enter both email and password', 'error');
      return;
    }
    
    try {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        updateStatus(`Login failed: ${error.message}`, 'error');
      } else {
        updateStatus(`Login successful! Welcome ${data.user?.email}`, 'success');
      }
      log({data, error}, "Login");
    } catch (err) {
      updateStatus(`Login error: ${err.message}`, 'error');
      log({error: err.message}, "Login Error");
    }
  }

  async function logout() {
    updateStatus('Logging out...', 'info');
    try {
      const { error } = await supabase.auth.signOut();
      if (error) {
        updateStatus(`Logout failed: ${error.message}`, 'error');
      } else {
        updateStatus('Logged out successfully', 'success');
      }
      log({ok: !error, error}, "Logout");
    } catch (err) {
      updateStatus(`Logout error: ${err.message}`, 'error');
      log({error: err.message}, "Logout Error");
    }
  }

  async function showSession() {
    updateStatus('Fetching Supabase session...', 'info');
    try {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (session) {
        updateStatus(`Session active for ${session.user?.email}`, 'success');
      } else {
        updateStatus('No active session', 'info');
      }
      log({ session, error }, "Supabase Session");
    } catch (err) {
      updateStatus(`Session error: ${err.message}`, 'error');
      log({error: err.message}, "Session Error");
    }
  }

  async function exchangeForAcsCookies() {
    updateStatus('Exchanging Supabase token for ACS cookies...', 'info');
    try {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error || !session?.access_token) {
        updateStatus('No Supabase session found. Please login first.', 'error');
        log({ error: error || "No session/access_token" }, "Exchange");
        return;
      }
      
      const access_token = session.access_token;
      const user = session.user || {};
      
      // POST to ACS oauth exchange to set HttpOnly cookies
      const exchangeUrl = `${ACS_BASE}/auth/oauth/exchange`;
      console.info("FETCH:", exchangeUrl);
      const res = await fetch(exchangeUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        // Critical: allow cookies to be set/sent cross-origin
        credentials: "include",
        body: JSON.stringify({
          provider: "supabase",
          access_token,
          refresh_token: null,
          user
        })
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus('Successfully exchanged for ACS cookies!', 'success');
      } else {
        updateStatus(`Exchange failed: ${json.detail || 'Unknown error'}`, 'error');
      }
      
      log({ 
        status: res.status, 
        json, 
        headers: Object.fromEntries(res.headers.entries())
      }, "Exchange Response");
    } catch (err) {
      updateStatus(`Exchange error: ${err.message}`, 'error');
      log({error: err.message}, "Exchange Error");
    }
  }

  async function whoAmI() {
    updateStatus('Checking ACS authentication...', 'info');
    try {
      // Get Supabase access token for Authorization header
      const { data: { session } } = await supabase.auth.getSession();
      const supaToken = session?.access_token;
      
      // Protected route that requires ACS cookies or Authorization header
      const whoAmIUrl = `${ACS_BASE}/auth/me`;
      console.info("FETCH:", whoAmIUrl);
      const res = await fetch(whoAmIUrl, {
        method: "GET",
        credentials: "include",
        headers: supaToken ? { Authorization: `Bearer ${supaToken}` } : {}
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Authenticated as ${json.email} (${json.authentication_method})`, 'success');
      } else {
        updateStatus(`Authentication failed: ${json.detail || 'Please exchange tokens first'}`, 'error');
      }
      
      log({ status: res.status, json }, "ACS /auth/me");
    } catch (err) {
      updateStatus(`Auth check error: ${err.message}`, 'error');
      log({error: err.message}, "Auth Check Error");
    }
  }

  async function provisionTest() {
    updateStatus('Testing provisioning (no auth required)...', 'info');
    try {
      // Dev-only helper that doesn't require auth
      const provisionTestUrl = `${ACS_BASE}/infrastructure/provision-test`;
      console.info("FETCH:", provisionTestUrl);
      const res = await fetch(provisionTestUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          region: "sjc",
          machine_config: { cpus: 1, memory_mb: 1024 },
          volume_config: { size_gb: 10 }
        })
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Provisioning test initiated: ${json.status}`, 'success');
      } else {
        updateStatus(`Provisioning test failed: ${json.detail || 'Unknown error'}`, 'error');
      }
      
      log({ status: res.status, json }, "/infrastructure/provision-test");
    } catch (err) {
      updateStatus(`Provisioning test error: ${err.message}`, 'error');
      log({error: err.message}, "Provision Test Error");
    }
  }

  async function provisionStrict() {
    updateStatus('Starting authenticated provisioning...', 'info');
    try {
      // Authenticated: requires ACS cookies set via exchange
      const res = await fetch(`${ACS_BASE}/infrastructure/provision`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({
          region: "sjc",
          machine_config: { cpus: 1, memory_mb: 1024 },
          volume_config: { size_gb: 10 }
        })
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Provisioning initiated: ${json.status}`, 'success');
      } else {
        updateStatus(`Provisioning failed: ${json.detail || 'Please authenticate first'}`, 'error');
      }
      
      log({ status: res.status, json }, "/infrastructure/provision");
    } catch (err) {
      updateStatus(`Provisioning error: ${err.message}`, 'error');
      log({error: err.message}, "Provision Error");
    }
  }

  async function checkInfraStatus() {
    updateStatus('Checking infrastructure status...', 'info');
    try {
      const res = await fetch(`${ACS_BASE}/infrastructure/status`, {
        method: "GET",
        credentials: "include"
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Infrastructure status: ${json.status}`, json.status === 'ready' ? 'success' : 'info');
      } else {
        updateStatus(`Status check failed: ${json.detail || 'Please authenticate first'}`, 'error');
      }
      
      log({ status: res.status, json }, "/infrastructure/status");
    } catch (err) {
      updateStatus(`Status check error: ${err.message}`, 'error');
      log({error: err.message}, "Status Check Error");
    }
  }

  async function provisionWithRepo() {
    updateStatus('Starting repository provisioning...', 'info');
    try {
      // Authenticated: requires ACS cookies
      const repo_id = Number(document.getElementById('repoId').value);
      const repo_name = document.getElementById('repoName').value.trim();
      const branch = document.getElementById('branch').value.trim();
      
      if (!repo_id || !repo_name || !branch) {
        updateStatus('Please fill in all repository fields', 'error');
        return;
      }
      
      const res = await fetch(`${ACS_BASE}/infrastructure/provision-with-repo`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ 
          repo_id, 
          repo_name, 
          branch, 
          region: "ord", 
          volume_size_gb: 10 
        })
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Repository provisioning initiated: ${json.status}`, 'success');
      } else {
        updateStatus(`Repository provisioning failed: ${json.detail || 'Please authenticate first'}`, 'error');
      }
      
      log({ status: res.status, json }, "/infrastructure/provision-with-repo");
    } catch (err) {
      updateStatus(`Repository provisioning error: ${err.message}`, 'error');
      log({error: err.message}, "Repo Provision Error");
    }
  }

  // GitHub Integration Functions
  async function githubInstall() {
    updateStatus('Opening GitHub App installation page...', 'info');
    
    // ğŸš€ HARDCODED: Direct GitHub App install URL (no API call needed)
    const hardcodedInstallUrl = "https://github.com/apps/orchestra-agents/installations/new";
    
    try {
      updateStatus('Opening GitHub App installation page...', 'success');
      window.open(hardcodedInstallUrl, '_blank');
      log({ install_url: hardcodedInstallUrl }, "GitHub Install URL (Hardcoded)");
    } catch (err) {
      updateStatus(`Failed to open GitHub install page: ${err.message}`, 'error');
      log({ error: err.message }, "GitHub Install Error");
    }
  }

  async function listInstalls() {
    updateStatus('Fetching GitHub installations...', 'info');
    try {
      // Get Supabase access token for Authorization header
      const { data: { session } } = await supabase.auth.getSession();
      const supaToken = session?.access_token;
      
      const installsUrl = `${ACS_BASE}/github/installations`;
      console.info("FETCH:", installsUrl);
      const res = await fetch(installsUrl, {
        method: "GET",
        credentials: "include",
        headers: supaToken ? { Authorization: `Bearer ${supaToken}` } : {}
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Found ${json.count || 0} GitHub installations`, 'success');
      } else {
        updateStatus(`Failed to list installations: ${json.detail || 'Please authenticate first'}`, 'error');
      }
      
      log({ status: res.status, json }, "GitHub Installations");
    } catch (err) {
      updateStatus(`GitHub installations error: ${err.message}`, 'error');
      log({error: err.message}, "GitHub Installations Error");
    }
  }

  async function listRepos() {
    updateStatus('Fetching accessible GitHub repositories...', 'info');
    try {
      // Get Supabase access token for Authorization header
      const { data: { session } } = await supabase.auth.getSession();
      const supaToken = session?.access_token;
      
      const reposUrl = `${ACS_BASE}/github/repos`;
      console.info("FETCH:", reposUrl);
      const res = await fetch(reposUrl, {
        method: "GET",
        credentials: "include",
        headers: supaToken ? { Authorization: `Bearer ${supaToken}` } : {}
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Found ${json.count || 0} accessible repositories`, 'success');
      } else {
        updateStatus(`Failed to list repos: ${json.detail || 'Please authenticate first'}`, 'error');
      }
      
      log({ status: res.status, json }, "GitHub Repositories");
    } catch (err) {
      updateStatus(`GitHub repos error: ${err.message}`, 'error');
      log({error: err.message}, "GitHub Repos Error");
    }
  }

  async function checkRepoStatus() {
    updateStatus('Checking repository infrastructure status...', 'info');
    try {
      // Get repository details from form
      const repo_id = Number(document.getElementById('repoId').value);
      const branch = document.getElementById('branch').value.trim();
      
      if (!repo_id || !branch) {
        updateStatus('Please fill in Repository ID and Branch fields', 'error');
        return;
      }
      
      // Get Supabase access token for Authorization header
      const { data: { session } } = await supabase.auth.getSession();
      const supaToken = session?.access_token;
      
      const repoStatusUrl = `${ACS_BASE}/infrastructure/repo-status?repo_id=${repo_id}&branch=${encodeURIComponent(branch)}`;
      console.info("FETCH:", repoStatusUrl);
      const res = await fetch(repoStatusUrl, {
        method: "GET",
        credentials: "include",
        headers: supaToken ? { Authorization: `Bearer ${supaToken}` } : {}
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        const status = json.status;
        let statusType = 'info';
        if (status === 'ready') statusType = 'success';
        else if (status === 'error') statusType = 'error';
        else if (status === 'not_found') statusType = 'info';
        
        updateStatus(`Repository status: ${status} (repo_id: ${repo_id}, branch: ${branch})`, statusType);
      } else {
        updateStatus(`Failed to check repo status: ${json.detail || 'Please authenticate first'}`, 'error');
      }
      
      log({ status: res.status, json }, "Repository Status Check");
    } catch (err) {
      updateStatus(`Repository status error: ${err.message}`, 'error');
      log({error: err.message}, "Repo Status Error");
    }
  }

  // New Repo Picker Functions
  let cachedRepos = []; // Store repos for later use
  
  function renderRepoList(repos) {
    const repoListContainer = document.getElementById('repoList');
    cachedRepos = repos || []; // Cache the repos for other functions
    
    if (!repos || repos.length === 0) {
      repoListContainer.innerHTML = '<p style="color: #6c757d; font-style: italic;">No repositories found. Make sure you have installed the GitHub App and have access to repositories.</p>';
      return;
    }
    
    let html = '';
    repos.forEach((repo, index) => {
      const repoId = repo.id || repo.repo_id;
      const repoName = repo.full_name || repo.name;
      const description = repo.description || 'No description';
      const isPrivate = repo.private ? 'ğŸ”’ Private' : 'ğŸŒ Public';
      const updatedAt = repo.updated_at ? new Date(repo.updated_at).toLocaleDateString() : 'Unknown';
      
      html += `
        <div class="repo-item" onclick="selectRepo(${index})">
          <input type="radio" name="selectedRepo" value="${index}" id="repo_${index}" />
          <div class="repo-info">
            <div class="repo-name">${repoName}</div>
            <div class="repo-details">
              ID: ${repoId} | ${isPrivate} | Updated: ${updatedAt}
              <br>${description}
            </div>
          </div>
        </div>
      `;
    });
    
    repoListContainer.innerHTML = html;
    updateStatus(`Loaded ${repos.length} repositories`, 'success');
  }
  
  function selectRepo(index) {
    const radio = document.getElementById(`repo_${index}`);
    if (radio) {
      radio.checked = true;
    }
  }

  async function loadReposIntoPicker() {
    updateStatus('Loading repositories into picker...', 'info');
    try {
      // Get Supabase access token for Authorization header
      const { data: { session } } = await supabase.auth.getSession();
      const supaToken = session?.access_token;
      
      const reposUrl = `${ACS_BASE}/github/repos`;
      console.info("FETCH:", reposUrl);
      const res = await fetch(reposUrl, {
        method: "GET",
        credentials: "include",
        headers: supaToken ? { Authorization: `Bearer ${supaToken}` } : {}
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        const repos = json.repositories || [];
        renderRepoList(repos);
        updateStatus(`Loaded ${repos.length} repositories into picker`, 'success');
      } else {
        updateStatus(`Failed to load repos: ${json.detail || 'Please authenticate first'}`, 'error');
        renderRepoList([]); // Clear the list
      }
      
      log({ status: res.status, json }, "Load Repos Into Picker");
    } catch (err) {
      updateStatus(`Load repos error: ${err.message}`, 'error');
      log({error: err.message}, "Load Repos Error");
      renderRepoList([]); // Clear the list on error
    }
  }

  function getSelectedRepo() {
    const selectedRadio = document.querySelector('input[name="selectedRepo"]:checked');
    if (!selectedRadio) {
      return null;
    }
    
    const index = parseInt(selectedRadio.value);
    if (isNaN(index) || index < 0 || index >= cachedRepos.length) {
      return null;
    }
    
    return cachedRepos[index];
  }

  async function provisionSelectedRepo() {
    updateStatus('Provisioning selected repository...', 'info');
    try {
      const selectedRepo = getSelectedRepo();
      if (!selectedRepo) {
        updateStatus('Please select a repository first', 'error');
        return;
      }
      
      const branch = document.getElementById('pollBranch').value.trim() || 'main';
      const repo_id = selectedRepo.id || selectedRepo.repo_id;
      const repo_name = selectedRepo.full_name || selectedRepo.name;
      
      if (!repo_id || !repo_name) {
        updateStatus('Selected repository is missing required information', 'error');
        return;
      }
      
      // Auto-fill the legacy form fields for compatibility
      document.getElementById('repoId').value = repo_id;
      document.getElementById('repoName').value = repo_name;
      document.getElementById('branch').value = branch;
      
      // Call the existing provisionWithRepo function
      await provisionWithRepo();
      
      log({ 
        selected_repo: selectedRepo, 
        branch, 
        action: 'provision_selected_repo' 
      }, "Provision Selected Repo");
      
    } catch (err) {
      updateStatus(`Provision selected repo error: ${err.message}`, 'error');
      log({error: err.message}, "Provision Selected Repo Error");
    }
  }

  async function checkRepoStatusOnce() {
    updateStatus('Checking selected repository status...', 'info');
    try {
      const selectedRepo = getSelectedRepo();
      if (!selectedRepo) {
        updateStatus('Please select a repository first', 'error');
        return;
      }
      
      const branch = document.getElementById('pollBranch').value.trim() || 'main';
      const repo_id = selectedRepo.id || selectedRepo.repo_id;
      
      if (!repo_id) {
        updateStatus('Selected repository is missing ID', 'error');
        return;
      }
      
      // Get Supabase access token for Authorization header
      const { data: { session } } = await supabase.auth.getSession();
      const supaToken = session?.access_token;
      
      const repoStatusUrl = `${ACS_BASE}/infrastructure/repo-status?repo_id=${repo_id}&branch=${encodeURIComponent(branch)}`;
      console.info("FETCH:", repoStatusUrl);
      const res = await fetch(repoStatusUrl, {
        method: "GET",
        credentials: "include",
        headers: supaToken ? { Authorization: `Bearer ${supaToken}` } : {}
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        const status = json.status;
        let statusType = 'info';
        if (status === 'ready') statusType = 'success';
        else if (status === 'error') statusType = 'error';
        else if (status === 'not_found') statusType = 'info';
        
        updateStatus(`Selected repo status: ${status} (${selectedRepo.full_name || selectedRepo.name}#${branch})`, statusType);
        
        // Return the status for auto-poll logic
        return { status, json };
      } else {
        updateStatus(`Failed to check selected repo status: ${json.detail || 'Please authenticate first'}`, 'error');
        return { status: 'error', json };
      }
      
    } catch (err) {
      updateStatus(`Selected repo status error: ${err.message}`, 'error');
      log({error: err.message}, "Selected Repo Status Error");
      return { status: 'error', error: err.message };
    }
  }

  // Auto-poll state
  let autoPollInterval = null;
  let isAutoPolling = false;

  async function toggleAutoPoll() {
    const toggleButton = document.getElementById('btnToggleAutoPoll');
    
    if (isAutoPolling) {
      // Stop auto-polling
      if (autoPollInterval) {
        clearInterval(autoPollInterval);
        autoPollInterval = null;
      }
      isAutoPolling = false;
      toggleButton.textContent = 'ğŸ”„ Toggle Auto Poll (5s)';
      toggleButton.classList.remove('auto-poll-active');
      updateStatus('Auto-polling stopped', 'info');
      
      log({ action: 'auto_poll_stopped' }, "Auto Poll Toggle");
    } else {
      // Start auto-polling
      const selectedRepo = getSelectedRepo();
      if (!selectedRepo) {
        updateStatus('Please select a repository before starting auto-poll', 'error');
        return;
      }
      
      isAutoPolling = true;
      toggleButton.textContent = 'â¹ï¸ Stop Auto Poll';
      toggleButton.classList.add('auto-poll-active');
      updateStatus(`Auto-polling started for ${selectedRepo.full_name || selectedRepo.name} (5s interval)`, 'success');
      
      // Start the polling interval
      autoPollInterval = setInterval(async () => {
        try {
          const result = await checkRepoStatusOnce();
          
          // Stop polling if status is 'ready'
          if (result && result.status === 'ready') {
            updateStatus(`Auto-poll complete: Repository is ready! Stopping auto-poll.`, 'success');
            toggleAutoPoll(); // This will stop the polling
          }
        } catch (err) {
          console.error('Auto-poll error:', err);
          // Continue polling even on errors, but log them
        }
      }, 5000); // 5 second interval
      
      log({ 
        action: 'auto_poll_started', 
        repo: selectedRepo.full_name || selectedRepo.name,
        interval_ms: 5000 
      }, "Auto Poll Toggle");
    }
  }

  // Wire up buttons
  document.getElementById('btnUpdateConfig').onclick = updateConfiguration;
  document.getElementById('btnResetConfig').onclick = resetConfiguration;
  document.getElementById('btnRegister').onclick = register;
  document.getElementById('btnLogin').onclick = login;
  document.getElementById('btnLogout').onclick = logout;
  document.getElementById('btnShowSession').onclick = showSession;
  document.getElementById('btnExchange').onclick = exchangeForAcsCookies;
  document.getElementById('btnWhoAmI').onclick = whoAmI;
  document.getElementById('btnProvisionTest').onclick = provisionTest;
  document.getElementById('btnProvision').onclick = provisionStrict;
  document.getElementById('btnInfraStatus').onclick = checkInfraStatus;
  document.getElementById('btnProvisionRepo').onclick = provisionWithRepo;
  document.getElementById('btnCheckRepoStatus').onclick = checkRepoStatus;
  
  // Wire up new repo picker buttons
  document.getElementById('btnLoadRepos').onclick = loadReposIntoPicker;
  document.getElementById('btnProvisionSelected').onclick = provisionSelectedRepo;
  document.getElementById('btnCheckRepoStatusSelected').onclick = checkRepoStatusOnce;
  document.getElementById('btnToggleAutoPoll').onclick = toggleAutoPoll;
  
  // Wire up GitHub buttons
  document.getElementById('btnGithubInstall').onclick = githubInstall;
  document.getElementById('btnListInstalls').onclick = listInstalls;
  document.getElementById('btnListRepos').onclick = listRepos;

  // Initialize
  updateStatus('Ready to test! Start by registering or logging in with Supabase.', 'info');
  
  // Show current ACS base URL
  setTimeout(() => {
    const currentBase = ACS_BASE.replace('/api/v1', '');
    updateStatus(`Ready to test! ACS Server: ${currentBase}`, 'info');
  }, 500);
  
  // Auto-check session on load
  setTimeout(showSession, 1000);
</script>
</body>
</html>