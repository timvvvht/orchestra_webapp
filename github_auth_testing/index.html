<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ACS Minimal Auth/Provision Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      max-width: 900px; 
      margin: 2rem auto; 
      padding: 0 1rem;
      line-height: 1.6;
    }
    input { 
      margin: 0.25rem; 
      padding: 0.6rem; 
      width: 320px; 
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button { 
      margin: 0.25rem; 
      padding: 0.6rem 1rem; 
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #6c757d; cursor: not-allowed; }
    pre { 
      background: #f8f9fa; 
      padding: 1rem; 
      white-space: pre-wrap; 
      border-radius: 4px;
      border: 1px solid #e9ecef;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .row { margin: 0.75rem 0; }
    .section { 
      margin: 2rem 0; 
      padding: 1.5rem; 
      border: 1px solid #e9ecef; 
      border-radius: 8px;
      background: #fdfdfd;
    }
    .status { 
      padding: 0.5rem 1rem; 
      border-radius: 4px; 
      margin: 0.5rem 0;
      font-weight: 500;
    }
    .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 0.5rem; }
    h2 { color: #495057; margin-top: 2rem; }
    h3 { color: #6c757d; }
    .button-group { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .input-group { display: flex; flex-direction: column; margin: 0.5rem 0; }
    .input-group label { font-weight: 500; margin-bottom: 0.25rem; color: #495057; }
  </style>
</head>
<body>
  <h1>üé≠ ACS Minimal Auth/Provision Test</h1>
  <div id="status" class="status info">Ready to test Supabase ‚Üí ACS authentication flow</div>

  <div class="section">
    <h2>‚öôÔ∏è Configuration</h2>
    
    <div class="input-group">
      <label for="acsBaseUrl">ACS Server URL</label>
      <input id="acsBaseUrl" type="url" placeholder="http://localhost:8001" value="http://localhost:8001" />
      <small style="color: #6c757d; font-size: 12px;">
        Local: http://localhost:8001 | Ngrok: https://your-ngrok-url.ngrok.io
      </small>
    </div>
    
    <div class="button-group">
      <button id="btnUpdateConfig">üîÑ Update Configuration</button>
      <button id="btnResetConfig">üè† Reset to Local</button>
    </div>
  </div>

  <div class="section">
    <h2>üîê Authentication</h2>
    
    <div class="input-group">
      <label for="email">Email</label>
      <input id="email" type="email" placeholder="your-email@example.com" value="test@example.com" />
    </div>
    
    <div class="input-group">
      <label for="password">Password</label>
      <input id="password" type="password" placeholder="password" value="testpassword123" />
    </div>

    <div class="button-group">
      <button id="btnRegister">üìù Supabase Register</button>
      <button id="btnLogin">üîë Supabase Login</button>
      <button id="btnLogout">üö™ Supabase Logout</button>
    </div>

    <div class="button-group">
      <button id="btnShowSession">üëÅÔ∏è Show Supabase Session</button>
      <button id="btnExchange">üîÑ Exchange for ACS Cookies</button>
      <button id="btnWhoAmI">üë§ ACS: Who Am I (/auth/me)</button>
    </div>
  </div>

  <div class="section">
    <h2>üêô GitHub Integration</h2>
    
    <div class="button-group">
      <button id="btnGithubInstall">üîó Connect GitHub (Install App)</button>
      <button id="btnListInstalls">üì¶ My Installations</button>
      <button id="btnListRepos">üìö My Repos</button>
    </div>
  </div>

  <div class="section">
    <h2>üèóÔ∏è Infrastructure Provisioning</h2>
    
    <h3>üìö Provision with Repository (Preferred)</h3>
    <div class="input-group">
      <label for="repoId">Repository ID (number)</label>
      <input id="repoId" type="number" placeholder="123456789" value="123456789" />
    </div>
    
    <div class="input-group">
      <label for="repoName">Repository Full Name</label>
      <input id="repoName" type="text" placeholder="owner/repository-name" value="octocat/Hello-World" />
    </div>
    
    <div class="input-group">
      <label for="branch">Branch</label>
      <input id="branch" type="text" placeholder="main" value="main" />
    </div>
    
    <div class="button-group">
      <button id="btnProvisionRepo">üöÄ Provision With Repo (preferred)</button>
    </div>

    <h3>üîí Legacy App-Per-User Provisioning</h3>
    <div class="button-group">
      <button id="btnProvisionTest">üß™ Provision (no auth) /infrastructure/provision-test</button>
      <button id="btnProvision" title="Legacy app-per-user path">üîí Provision (legacy)</button>
      <button id="btnInfraStatus">üìä Infrastructure Status</button>
    </div>
  </div>

  <div class="section">
    <h2>üìã Output</h2>
    <pre id="out">Click any button above to see the API response...</pre>
  </div>

<script>
  // Your Supabase project configuration
  const SUPABASE_URL = "https://wurmfjxtyntxnstqbyms.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1cm1manh0eW50eG5zdHFieW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3Nzg2NTgsImV4cCI6MjA2MzM1NDY1OH0.jVjPr-AesbxARpPC0YLtHYQy9OGqdEA5FowJPYKwBcc";

  // ACS base URL (configurable)
  let ACS_BASE = "http://localhost:8001/api/v1";

  const out = document.getElementById('out');
  const status = document.getElementById('status');
  
  function updateStatus(message, type = 'info') {
    status.className = `status ${type}`;
    status.textContent = message;
  }
  
  function log(obj, title = "") {
    const timestamp = new Date().toLocaleTimeString();
    const output = (title ? `[${timestamp}] ${title}\n` : `[${timestamp}] `) + JSON.stringify(obj, null, 2);
    out.textContent = output;
    console.log(title || 'API Response:', obj);
  }

  // Configuration functions
  function updateConfiguration() {
    const newBaseUrl = document.getElementById('acsBaseUrl').value.trim();
    if (!newBaseUrl) {
      updateStatus('Please enter a valid ACS server URL', 'error');
      return;
    }
    
    // Remove trailing slash and add /api/v1
    const cleanUrl = newBaseUrl.replace(/\/$/, '');
    ACS_BASE = `${cleanUrl}/api/v1`;
    
    updateStatus(`Configuration updated! ACS Base: ${ACS_BASE}`, 'success');
    log({ 
      action: 'config_updated', 
      old_base: 'previous_value',
      new_base: ACS_BASE,
      timestamp: new Date().toISOString()
    }, "Configuration Update");
  }
  
  function resetConfiguration() {
    const defaultUrl = "http://localhost:8001";
    document.getElementById('acsBaseUrl').value = defaultUrl;
    ACS_BASE = `${defaultUrl}/api/v1`;
    
    updateStatus('Configuration reset to local development', 'info');
    log({ 
      action: 'config_reset', 
      base_url: ACS_BASE,
      timestamp: new Date().toISOString()
    }, "Configuration Reset");
  }

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function register() {
    updateStatus('Registering with Supabase...', 'info');
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
      updateStatus('Please enter both email and password', 'error');
      return;
    }
    
    try {
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) {
        updateStatus(`Registration failed: ${error.message}`, 'error');
      } else {
        updateStatus('Registration successful! Check your email for confirmation.', 'success');
      }
      log({data, error}, "Register");
    } catch (err) {
      updateStatus(`Registration error: ${err.message}`, 'error');
      log({error: err.message}, "Register Error");
    }
  }

  async function login() {
    updateStatus('Logging in with Supabase...', 'info');
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
      updateStatus('Please enter both email and password', 'error');
      return;
    }
    
    try {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        updateStatus(`Login failed: ${error.message}`, 'error');
      } else {
        updateStatus(`Login successful! Welcome ${data.user?.email}`, 'success');
      }
      log({data, error}, "Login");
    } catch (err) {
      updateStatus(`Login error: ${err.message}`, 'error');
      log({error: err.message}, "Login Error");
    }
  }

  async function logout() {
    updateStatus('Logging out...', 'info');
    try {
      const { error } = await supabase.auth.signOut();
      if (error) {
        updateStatus(`Logout failed: ${error.message}`, 'error');
      } else {
        updateStatus('Logged out successfully', 'success');
      }
      log({ok: !error, error}, "Logout");
    } catch (err) {
      updateStatus(`Logout error: ${err.message}`, 'error');
      log({error: err.message}, "Logout Error");
    }
  }

  async function showSession() {
    updateStatus('Fetching Supabase session...', 'info');
    try {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (session) {
        updateStatus(`Session active for ${session.user?.email}`, 'success');
      } else {
        updateStatus('No active session', 'info');
      }
      log({ session, error }, "Supabase Session");
    } catch (err) {
      updateStatus(`Session error: ${err.message}`, 'error');
      log({error: err.message}, "Session Error");
    }
  }

  async function exchangeForAcsCookies() {
    updateStatus('Exchanging Supabase token for ACS cookies...', 'info');
    try {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error || !session?.access_token) {
        updateStatus('No Supabase session found. Please login first.', 'error');
        log({ error: error || "No session/access_token" }, "Exchange");
        return;
      }
      
      const access_token = session.access_token;
      const user = session.user || {};
      
      // POST to ACS oauth exchange to set HttpOnly cookies
      const exchangeUrl = `${ACS_BASE}/auth/oauth/exchange`;
      console.info("FETCH:", exchangeUrl);
      const res = await fetch(exchangeUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        // Critical: allow cookies to be set/sent cross-origin
        credentials: "include",
        body: JSON.stringify({
          provider: "supabase",
          access_token,
          refresh_token: null,
          user
        })
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus('Successfully exchanged for ACS cookies!', 'success');
      } else {
        updateStatus(`Exchange failed: ${json.detail || 'Unknown error'}`, 'error');
      }
      
      log({ 
        status: res.status, 
        json, 
        headers: Object.fromEntries(res.headers.entries())
      }, "Exchange Response");
    } catch (err) {
      updateStatus(`Exchange error: ${err.message}`, 'error');
      log({error: err.message}, "Exchange Error");
    }
  }

  async function whoAmI() {
    updateStatus('Checking ACS authentication...', 'info');
    try {
      // Get Supabase access token for Authorization header
      const { data: { session } } = await supabase.auth.getSession();
      const supaToken = session?.access_token;
      
      // Protected route that requires ACS cookies or Authorization header
      const whoAmIUrl = `${ACS_BASE}/auth/me`;
      console.info("FETCH:", whoAmIUrl);
      const res = await fetch(whoAmIUrl, {
        method: "GET",
        credentials: "include",
        headers: supaToken ? { Authorization: `Bearer ${supaToken}` } : {}
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Authenticated as ${json.email} (${json.authentication_method})`, 'success');
      } else {
        updateStatus(`Authentication failed: ${json.detail || 'Please exchange tokens first'}`, 'error');
      }
      
      log({ status: res.status, json }, "ACS /auth/me");
    } catch (err) {
      updateStatus(`Auth check error: ${err.message}`, 'error');
      log({error: err.message}, "Auth Check Error");
    }
  }

  async function provisionTest() {
    updateStatus('Testing provisioning (no auth required)...', 'info');
    try {
      // Dev-only helper that doesn't require auth
      const provisionTestUrl = `${ACS_BASE}/infrastructure/provision-test`;
      console.info("FETCH:", provisionTestUrl);
      const res = await fetch(provisionTestUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          region: "sjc",
          machine_config: { cpus: 1, memory_mb: 1024 },
          volume_config: { size_gb: 10 }
        })
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Provisioning test initiated: ${json.status}`, 'success');
      } else {
        updateStatus(`Provisioning test failed: ${json.detail || 'Unknown error'}`, 'error');
      }
      
      log({ status: res.status, json }, "/infrastructure/provision-test");
    } catch (err) {
      updateStatus(`Provisioning test error: ${err.message}`, 'error');
      log({error: err.message}, "Provision Test Error");
    }
  }

  async function provisionStrict() {
    updateStatus('Starting authenticated provisioning...', 'info');
    try {
      // Authenticated: requires ACS cookies set via exchange
      const res = await fetch(`${ACS_BASE}/infrastructure/provision`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({
          region: "sjc",
          machine_config: { cpus: 1, memory_mb: 1024 },
          volume_config: { size_gb: 10 }
        })
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Provisioning initiated: ${json.status}`, 'success');
      } else {
        updateStatus(`Provisioning failed: ${json.detail || 'Please authenticate first'}`, 'error');
      }
      
      log({ status: res.status, json }, "/infrastructure/provision");
    } catch (err) {
      updateStatus(`Provisioning error: ${err.message}`, 'error');
      log({error: err.message}, "Provision Error");
    }
  }

  async function checkInfraStatus() {
    updateStatus('Checking infrastructure status...', 'info');
    try {
      const res = await fetch(`${ACS_BASE}/infrastructure/status`, {
        method: "GET",
        credentials: "include"
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Infrastructure status: ${json.status}`, json.status === 'ready' ? 'success' : 'info');
      } else {
        updateStatus(`Status check failed: ${json.detail || 'Please authenticate first'}`, 'error');
      }
      
      log({ status: res.status, json }, "/infrastructure/status");
    } catch (err) {
      updateStatus(`Status check error: ${err.message}`, 'error');
      log({error: err.message}, "Status Check Error");
    }
  }

  async function provisionWithRepo() {
    updateStatus('Starting repository provisioning...', 'info');
    try {
      // Authenticated: requires ACS cookies
      const repo_id = Number(document.getElementById('repoId').value);
      const repo_name = document.getElementById('repoName').value.trim();
      const branch = document.getElementById('branch').value.trim();
      
      if (!repo_id || !repo_name || !branch) {
        updateStatus('Please fill in all repository fields', 'error');
        return;
      }
      
      const res = await fetch(`${ACS_BASE}/infrastructure/provision-with-repo`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ 
          repo_id, 
          repo_name, 
          branch, 
          region: "ord", 
          volume_size_gb: 10 
        })
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Repository provisioning initiated: ${json.status}`, 'success');
      } else {
        updateStatus(`Repository provisioning failed: ${json.detail || 'Please authenticate first'}`, 'error');
      }
      
      log({ status: res.status, json }, "/infrastructure/provision-with-repo");
    } catch (err) {
      updateStatus(`Repository provisioning error: ${err.message}`, 'error');
      log({error: err.message}, "Repo Provision Error");
    }
  }

  // GitHub Integration Functions
  async function githubInstall() {
    updateStatus('Opening GitHub App installation page...', 'info');
    
    // üöÄ HARDCODED: Direct GitHub App install URL (no API call needed)
    const hardcodedInstallUrl = "https://github.com/apps/orchestra-agents/installations/new";
    
    try {
      updateStatus('Opening GitHub App installation page...', 'success');
      window.open(hardcodedInstallUrl, '_blank');
      log({ install_url: hardcodedInstallUrl }, "GitHub Install URL (Hardcoded)");
    } catch (err) {
      updateStatus(`Failed to open GitHub install page: ${err.message}`, 'error');
      log({ error: err.message }, "GitHub Install Error");
    }
  }

  async function listInstalls() {
    updateStatus('Fetching GitHub installations...', 'info');
    try {
      // Get Supabase access token for Authorization header
      const { data: { session } } = await supabase.auth.getSession();
      const supaToken = session?.access_token;
      
      const installsUrl = `${ACS_BASE}/github/installations`;
      console.info("FETCH:", installsUrl);
      const res = await fetch(installsUrl, {
        method: "GET",
        credentials: "include",
        headers: supaToken ? { Authorization: `Bearer ${supaToken}` } : {}
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Found ${json.count || 0} GitHub installations`, 'success');
      } else {
        updateStatus(`Failed to list installations: ${json.detail || 'Please authenticate first'}`, 'error');
      }
      
      log({ status: res.status, json }, "GitHub Installations");
    } catch (err) {
      updateStatus(`GitHub installations error: ${err.message}`, 'error');
      log({error: err.message}, "GitHub Installations Error");
    }
  }

  async function listRepos() {
    updateStatus('Fetching accessible GitHub repositories...', 'info');
    try {
      // Get Supabase access token for Authorization header
      const { data: { session } } = await supabase.auth.getSession();
      const supaToken = session?.access_token;
      
      const reposUrl = `${ACS_BASE}/github/repos`;
      console.info("FETCH:", reposUrl);
      const res = await fetch(reposUrl, {
        method: "GET",
        credentials: "include",
        headers: supaToken ? { Authorization: `Bearer ${supaToken}` } : {}
      });
      
      const json = await res.json().catch(() => ({}));
      
      if (res.ok) {
        updateStatus(`Found ${json.count || 0} accessible repositories`, 'success');
      } else {
        updateStatus(`Failed to list repos: ${json.detail || 'Please authenticate first'}`, 'error');
      }
      
      log({ status: res.status, json }, "GitHub Repositories");
    } catch (err) {
      updateStatus(`GitHub repos error: ${err.message}`, 'error');
      log({error: err.message}, "GitHub Repos Error");
    }
  }



  // Wire up buttons
  document.getElementById('btnUpdateConfig').onclick = updateConfiguration;
  document.getElementById('btnResetConfig').onclick = resetConfiguration;
  document.getElementById('btnRegister').onclick = register;
  document.getElementById('btnLogin').onclick = login;
  document.getElementById('btnLogout').onclick = logout;
  document.getElementById('btnShowSession').onclick = showSession;
  document.getElementById('btnExchange').onclick = exchangeForAcsCookies;
  document.getElementById('btnWhoAmI').onclick = whoAmI;
  document.getElementById('btnProvisionTest').onclick = provisionTest;
  document.getElementById('btnProvision').onclick = provisionStrict;
  document.getElementById('btnInfraStatus').onclick = checkInfraStatus;
  document.getElementById('btnProvisionRepo').onclick = provisionWithRepo;
  
  // Wire up GitHub buttons
  document.getElementById('btnGithubInstall').onclick = githubInstall;
  document.getElementById('btnListInstalls').onclick = listInstalls;
  document.getElementById('btnListRepos').onclick = listRepos;

  // Initialize
  updateStatus('Ready to test! Start by registering or logging in with Supabase.', 'info');
  
  // Show current ACS base URL
  setTimeout(() => {
    const currentBase = ACS_BASE.replace('/api/v1', '');
    updateStatus(`Ready to test! ACS Server: ${currentBase}`, 'info');
  }, 500);
  
  // Auto-check session on load
  setTimeout(showSession, 1000);
</script>
</body>
</html>